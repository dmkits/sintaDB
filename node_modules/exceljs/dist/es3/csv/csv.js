/*! ExcelJS 28-04-2017 */
"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},fs=require("fs"),csv=require("fast-csv"),moment=require("moment"),PromishLib=require("../utils/promish"),utils=require("../utils/utils"),SpecialValues={true:!0,false:!1,"#N/A":{error:"#N/A"},"#REF!":{error:"#REF!"},"#NAME?":{error:"#NAME?"},"#DIV/0!":{error:"#DIV/0!"},"#NULL!":{error:"#NULL!"},"#VALUE!":{error:"#VALUE!"},"#NUM!":{error:"#NUM!"}};(module.exports=function(a){this.workbook=a,this.worksheet=null}).prototype={readFile:function(a,b){var c=this;b=b||{};var d;return utils.fs.exists(a).then(function(e){if(!e)throw new Error("File not found: "+a);return d=fs.createReadStream(a),c.read(d,b)}).then(function(a){return d.close(),a})},read:function(a,b){var c=this;return b=b||{},new PromishLib.Promish(function(d,e){var f=c.createInputStream(b).on("worksheet",d).on("error",e);a.pipe(f)})},createInputStream:function(a){a=a||{};var b=this.workbook.addWorksheet(a.sheetName),c=a.dateFormats||[moment.ISO_8601,"MM-DD-YYYY","YYYY-MM-DD"],d=a.map||function(a){if(""===a)return null;if(!isNaN(a))return parseFloat(a);var b=moment(a,c,!0);if(b.isValid())return new Date(b.valueOf());var d=SpecialValues[a];return void 0!==d?d:a},e=csv(a).on("data",function(a){b.addRow(a.map(d))}).on("end",function(){e.emit("worksheet",b)});return e},write:function(a,b){var c=this;return new PromishLib.Promish(function(d,e){b=b||{};var f=c.workbook.getWorksheet(b.sheetName||b.sheetId),g=csv.createWriteStream(b);a.on("finish",function(){d()}),g.on("error",e),g.pipe(a);var h=b.dateFormat,i=b.map||function(a){if(a){if(a.text||a.hyperlink)return a.hyperlink||a.text||"";if(a.formula||a.result)return a.result||"";if(a instanceof Date)return h?moment(a).format(h):moment(a).format();if(a.error)return a.error;if("object"===(void 0===a?"undefined":_typeof(a)))return JSON.stringify(a)}return a},j=void 0===b.includeEmptyRows||b.includeEmptyRows,k=1;f&&f.eachRow(function(a,b){if(j)for(;k++<b-1;)g.write([]);var c=a.values;c.shift(),g.write(c.map(i)),k=b}),g.end()})},writeFile:function(a,b){b=b||{};var c=(b.encoding,fs.createWriteStream(a,b));return this.write(c,b)}};