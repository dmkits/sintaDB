/*! ExcelJS 28-04-2017 */
"use strict";var events=require("events"),PromishLib=require("../../../utils/promish"),utils=require("../../../utils/utils"),Enums=require("../../../doc/enums"),XmlStream=require("../../../utils/xml-stream"),BaseXform=require("../base-xform"),StaticXform=require("../static-xform"),ListXform=require("../list-xform"),FontXform=require("./font-xform"),FillXform=require("./fill-xform"),BorderXform=require("./border-xform"),NumFmtXform=require("./numfmt-xform"),StyleXform=require("./style-xform"),NUMFMT_BASE=164,StylesXform=module.exports=function(a){this.map={numFmts:new ListXform({tag:"numFmts",count:!0,childXform:new NumFmtXform}),fonts:new ListXform({tag:"fonts",count:!0,childXform:new FontXform,$:{"x14ac:knownFonts":1}}),fills:new ListXform({tag:"fills",count:!0,childXform:new FillXform}),borders:new ListXform({tag:"borders",count:!0,childXform:new BorderXform}),cellStyleXfs:new ListXform({tag:"cellStyleXfs",count:!0,childXform:new StyleXform}),cellXfs:new ListXform({tag:"cellXfs",count:!0,childXform:new StyleXform({xfId:!0})}),numFmt:new NumFmtXform,font:new FontXform,fill:new FillXform,border:new BorderXform,style:new StyleXform({xfId:!0}),cellStyles:StylesXform.STATIC_XFORMS.cellStyles,dxfs:StylesXform.STATIC_XFORMS.dxfs,tableStyles:StylesXform.STATIC_XFORMS.tableStyles,extLst:StylesXform.STATIC_XFORMS.extLst},a&&this.init()};utils.inherits(StylesXform,BaseXform,{STYLESHEET_ATTRIBUTES:{xmlns:"http://schemas.openxmlformats.org/spreadsheetml/2006/main","xmlns:mc":"http://schemas.openxmlformats.org/markup-compatibility/2006","mc:Ignorable":"x14ac x16r2","xmlns:x14ac":"http://schemas.microsoft.com/office/spreadsheetml/2009/9/ac","xmlns:x16r2":"http://schemas.microsoft.com/office/spreadsheetml/2015/02/main"},STATIC_XFORMS:{cellStyles:new StaticXform({tag:"cellStyles",$:{count:1},c:[{tag:"cellStyle",$:{name:"Normal",xfId:0,builtinId:0}}]}),dxfs:new StaticXform({tag:"dxfs",$:{count:0}}),tableStyles:new StaticXform({tag:"tableStyles",$:{count:0,defaultTableStyle:"TableStyleMedium2",defaultPivotStyle:"PivotStyleLight16"}}),extLst:new StaticXform({tag:"extLst",c:[{tag:"ext",$:{uri:"{EB79DEF2-80B8-43e5-95BD-54CBDDF9020C}","xmlns:x14":"http://schemas.microsoft.com/office/spreadsheetml/2009/9/main"},c:[{tag:"x14:slicerStyles",$:{defaultSlicerStyle:"SlicerStyleLight1"}}]},{tag:"ext",$:{uri:"{9260A510-F301-46a8-8635-F512D64BE5F5}","xmlns:x15":"http://schemas.microsoft.com/office/spreadsheetml/2010/11/main"},c:[{tag:"x15:timelineStyles",$:{defaultTimelineStyle:"TimeSlicerStyleLight1"}}]}]})}},{initIndex:function(){this.index={style:{},numFmt:{},numFmtNextId:164,font:{},border:{},fill:{}}},init:function(){this.model={styles:[],numFmts:[],fonts:[],borders:[],fills:[]},this.initIndex(),this._addFont({size:11,color:{theme:1},name:"Calibri",family:2,scheme:"minor"}),this._addBorder({}),this._addStyle({numFmtId:0,fontId:0,fillId:0,borderId:0,xfId:0}),this._addFill({type:"pattern",pattern:"none"}),this._addFill({type:"pattern",pattern:"gray125"})},render:function(a,b){b=b||this.model,a.openXml(XmlStream.StdDocAttributes),a.openNode("styleSheet",StylesXform.STYLESHEET_ATTRIBUTES),this.index?(b.numFmts&&b.numFmts.length&&(a.openNode("numFmts",{count:b.numFmts.length}),b.numFmts.forEach(function(b){a.writeXml(b)}),a.closeNode()),a.openNode("fonts",{count:b.fonts.length}),b.fonts.forEach(function(b){a.writeXml(b)}),a.closeNode(),a.openNode("fills",{count:b.fills.length}),b.fills.forEach(function(b){a.writeXml(b)}),a.closeNode(),a.openNode("borders",{count:b.borders.length}),b.borders.forEach(function(b){a.writeXml(b)}),a.closeNode(),this.map.cellStyleXfs.render(a,[{numFmtId:0,fontId:0,fillId:0,borderId:0,xfId:0}]),a.openNode("cellXfs",{count:b.styles.length}),b.styles.forEach(function(b){a.writeXml(b)}),a.closeNode()):(this.map.numFmts.render(a,b.numFmts),this.map.fonts.render(a,b.fonts),this.map.fills.render(a,b.fills),this.map.borders.render(a,b.borders),this.map.cellStyleXfs.render(a,[{numFmtId:0,fontId:0,fillId:0,borderId:0,xfId:0}]),this.map.cellXfs.render(a,b.styles)),StylesXform.STATIC_XFORMS.cellStyles.render(a),StylesXform.STATIC_XFORMS.dxfs.render(a),StylesXform.STATIC_XFORMS.tableStyles.render(a),StylesXform.STATIC_XFORMS.extLst.render(a),a.closeNode()},parseOpen:function(a){if(this.parser)return this.parser.parseOpen(a),!0;switch(a.name){case"styleSheet":return this.initIndex(),!0;default:return this.parser=this.map[a.name],this.parser&&this.parser.parseOpen(a),!0}},parseText:function(a){this.parser&&this.parser.parseText(a)},parseClose:function(a){if(this.parser)return this.parser.parseClose(a)||(this.parser=void 0),!0;switch(a){case"styleSheet":var b=this.model={},c=function(a,c){c.model&&c.model.length&&(b[a]=c.model)};if(c("numFmts",this.map.numFmts),c("fonts",this.map.fonts),c("fills",this.map.fills),c("borders",this.map.borders),c("styles",this.map.cellXfs),this.index={model:[],numFmt:[]},b.numFmts){var d=this.index.numFmt;b.numFmts.forEach(function(a){d[a.id]=a.formatCode})}return!1;default:return!0}},addStyleModel:function(a,b){if(!a)return 0;if(this.weakMap&&this.weakMap.has(a))return this.weakMap.get(a);var c={};if(b=b||Enums.ValueType.Number,a.numFmt)c.numFmtId=this._addNumFmtStr(a.numFmt);else switch(b){case Enums.ValueType.Number:c.numFmtId=this._addNumFmtStr("General");break;case Enums.ValueType.Date:c.numFmtId=this._addNumFmtStr("mm-dd-yy")}a.font&&(c.fontId=this._addFont(a.font)),a.border&&(c.borderId=this._addBorder(a.border)),a.fill&&(c.fillId=this._addFill(a.fill)),a.alignment&&(c.alignment=a.alignment);var d=this._addStyle(c);return this.weakMap&&this.weakMap.set(a,d),d},getStyleModel:function(a){function b(a,b,d){if(d){var e=b[d];e&&(c[a]=e)}}var c=this.index.model[a];if(c)return c;var d=this.model.styles[a];if(!d)return null;if(c=this.index.model[a]={},d.numFmtId){var e=this.index.numFmt[d.numFmtId]||NumFmtXform.getDefaultFmtCode(d.numFmtId);e&&(c.numFmt=e)}return b("font",this.model.fonts,d.fontId),b("border",this.model.borders,d.borderId),b("fill",this.model.fills,d.fillId),d.alignment&&(c.alignment=d.alignment),c},_addStyle:function(a){var b=this.map.style.toXml(a),c=this.index.style[b];return void 0===c&&(c=this.index.style[b]=this.model.styles.length,this.model.styles.push(b)),c},_addNumFmtStr:function(a){var b=NumFmtXform.getDefaultFmtId(a);if(void 0!==b)return b;if(b=this.index.numFmt[a],void 0!==b)return b;b=this.index.numFmt[a]=164+this.model.numFmts.length;var c=this.map.numFmt.toXml({id:b,formatCode:a});return this.model.numFmts.push(c),b},_addFont:function(a){var b=this.map.font.toXml(a),c=this.index.font[b];return void 0===c&&(c=this.index.font[b]=this.model.fonts.length,this.model.fonts.push(b)),c},_addBorder:function(a){var b=this.map.border.toXml(a),c=this.index.border[b];return void 0===c&&(c=this.index.border[b]=this.model.borders.length,this.model.borders.push(b)),c},_addFill:function(a){var b=this.map.fill.toXml(a),c=this.index.fill[b];return void 0===c&&(c=this.index.fill[b]=this.model.fills.length,this.model.fills.push(b)),c}}),StylesXform.Mock=function(){StylesXform.call(this),this.model={styles:[{numFmtId:0,fontId:0,fillId:0,borderId:0,xfId:0}],numFmts:[],fonts:[{size:11,color:{theme:1},name:"Calibri",family:2,scheme:"minor"}],borders:[{}],fills:[{type:"pattern",pattern:"none"},{type:"pattern",pattern:"gray125"}]}},utils.inherits(StylesXform.Mock,StylesXform,{parseStream:function(a){return a.autodrain(),PromishLib.Promish.resolve()},addStyleModel:function(a,b){switch(b){case Enums.ValueType.Date:return this.dateStyleId;default:return 0}},get dateStyleId(){if(!this._dateStyleId){var a={numFmtId:NumFmtXform.getDefaultFmtId("mm-dd-yy")};this._dateStyleId=this.model.styles.length,this.model.styles.push(a)}return this._dateStyleId},getStyleModel:function(){return{}}});