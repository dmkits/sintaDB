/*! ExcelJS 28-04-2017 */
"use strict";var _=require("../../../utils/under-dash"),utils=require("../../../utils/utils"),colCache=require("../../../utils/col-cache"),XmlStream=require("../../../utils/xml-stream"),BaseXform=require("../base-xform"),StaticXform=require("../static-xform"),ListXform=require("../list-xform"),DefinedNameXform=require("./defined-name-xform"),SheetXform=require("./sheet-xform"),WorkbookViewXform=require("./workbook-view-xform"),WorkbookPropertiesXform=require("./workbook-properties-xform"),WorkbookXform=module.exports=function(){this.map={fileVersion:WorkbookXform.STATIC_XFORMS.fileVersion,workbookPr:new WorkbookPropertiesXform,bookViews:new ListXform({tag:"bookViews",count:!1,childXform:new WorkbookViewXform}),sheets:new ListXform({tag:"sheets",count:!1,childXform:new SheetXform}),definedNames:new ListXform({tag:"definedNames",count:!1,childXform:new DefinedNameXform}),calcPr:WorkbookXform.STATIC_XFORMS.calcPr}};utils.inherits(WorkbookXform,BaseXform,{WORKBOOK_ATTRIBUTES:{xmlns:"http://schemas.openxmlformats.org/spreadsheetml/2006/main","xmlns:r":"http://schemas.openxmlformats.org/officeDocument/2006/relationships","xmlns:mc":"http://schemas.openxmlformats.org/markup-compatibility/2006","mc:Ignorable":"x15","xmlns:x15":"http://schemas.microsoft.com/office/spreadsheetml/2010/11/main"},STATIC_XFORMS:{fileVersion:new StaticXform({tag:"fileVersion",$:{appName:"xl",lastEdited:5,lowestEdited:5,rupBuild:9303}}),calcPr:new StaticXform({tag:"calcPr",$:{calcId:171027}})}},{prepare:function(a){a.sheets=a.worksheets;var b=[],c=0;a.sheets.forEach(function(a){if(a.pageSetup&&a.pageSetup.printArea){var d={name:"_xlnm.Print_Area",ranges:["'"+a.name+"'!"+a.pageSetup.printArea],localSheetId:c};b.push(d)}c++}),b.length&&(a.definedNames=a.definedNames.concat(b))},render:function(a,b){a.openXml(XmlStream.StdDocAttributes),a.openNode("workbook",WorkbookXform.WORKBOOK_ATTRIBUTES),this.map.fileVersion.render(a),this.map.workbookPr.render(a,b.properties),this.map.bookViews.render(a,b.views),this.map.sheets.render(a,b.sheets),this.map.definedNames.render(a,b.definedNames),this.map.calcPr.render(a),a.closeNode()},parseOpen:function(a){if(this.parser)return this.parser.parseOpen(a),!0;switch(a.name){case"workbook":return!0;default:return this.parser=this.map[a.name],this.parser&&this.parser.parseOpen(a),!0}},parseText:function(a){this.parser&&this.parser.parseText(a)},parseClose:function(a){if(this.parser)return this.parser.parseClose(a)||(this.parser=void 0),!0;switch(a){case"workbook":return this.model={sheets:this.map.sheets.model,properties:this.map.workbookPr.model,views:this.map.bookViews.model},this.map.definedNames.model&&(this.model.definedNames=this.map.definedNames.model),!1;default:return!0}},reconcile:function(a){var b,c=a.workbookRels.reduce(function(a,b){return a[b.rId]=b,a},{}),d=[],e=0;a.sheets.forEach(function(f){var g=c[f.rId];g&&(b=a.worksheetHash["xl/"+g.target],b.name=f.name,b.id=f.id,d[e++]=b)});var f=[];_.each(a.definedNames,function(a){if("_xlnm.Print_Area"===a.name){if(b=d[a.localSheetId]){b.pageSetup||(b.pageSetup={});var c=colCache.decodeEx(a.ranges[0]);b.pageSetup.printArea=c.dimensions}}else f.push(a)}),a.definedNames=f}});