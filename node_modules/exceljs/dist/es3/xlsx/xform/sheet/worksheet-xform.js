/*! ExcelJS 28-04-2017 */
"use strict";var events=require("events"),_=require("../../../utils/under-dash"),Enums=require("../../../doc/enums"),utils=require("../../../utils/utils"),XmlStream=require("../../../utils/xml-stream"),Merges=require("./merges"),HyperlinkMap=require("./hyperlink-map"),BaseXform=require("../base-xform"),ListXform=require("../list-xform"),RowXform=require("./row-xform"),ColXform=require("./col-xform"),DimensionXform=require("./dimension-xform"),HyperlinkXform=require("./hyperlink-xform"),MergeCellXform=require("./merge-cell-xform"),DataValidationsXform=require("./data-validations-xform"),SheetPropertiesXform=require("./sheet-properties-xform"),SheetFormatPropertiesXform=require("./sheet-format-properties-xform"),SheetViewXform=require("./sheet-view-xform"),PageMarginsXform=require("./page-margins-xform"),PageSetupXform=require("./page-setup-xform"),PrintOptionsXform=require("./print-options-xform"),AutoFilterXform=require("./auto-filter-xform"),WorkSheetXform=module.exports=function(){this.map={sheetPr:new SheetPropertiesXform,dimension:new DimensionXform,sheetViews:new ListXform({tag:"sheetViews",count:!1,childXform:new SheetViewXform}),sheetFormatPr:new SheetFormatPropertiesXform,cols:new ListXform({tag:"cols",count:!1,childXform:new ColXform}),sheetData:new ListXform({tag:"sheetData",count:!1,empty:!0,childXform:new RowXform}),autoFilter:new AutoFilterXform,mergeCells:new ListXform({tag:"mergeCells",count:!0,childXform:new MergeCellXform}),hyperlinks:new ListXform({tag:"hyperlinks",count:!1,childXform:new HyperlinkXform}),pageMargins:new PageMarginsXform,dataValidations:new DataValidationsXform,pageSetup:new PageSetupXform,printOptions:new PrintOptionsXform}};utils.inherits(WorkSheetXform,BaseXform,{WORKSHEET_ATTRIBUTES:{xmlns:"http://schemas.openxmlformats.org/spreadsheetml/2006/main","xmlns:r":"http://schemas.openxmlformats.org/officeDocument/2006/relationships","xmlns:mc":"http://schemas.openxmlformats.org/markup-compatibility/2006","mc:Ignorable":"x14ac","xmlns:x14ac":"http://schemas.microsoft.com/office/spreadsheetml/2009/9/ac"}},{prepare:function(a,b){b.merges=new Merges,a.hyperlinks=b.hyperlinks=[],b.formulae={},b.siFormulae=0,this.map.cols.prepare(a.cols,b),this.map.sheetData.prepare(a.rows,b),a.mergeCells=b.merges.mergeCells},render:function(a,b){a.openXml(XmlStream.StdDocAttributes),a.openNode("worksheet",WorkSheetXform.WORKSHEET_ATTRIBUTES);var c=b.properties?{defaultRowHeight:b.properties.defaultRowHeight,dyDescent:b.properties.dyDescent,outlineLevelCol:b.properties.outlineLevelCol,outlineLevelRow:b.properties.outlineLevelRow}:void 0,d={tabColor:b.properties&&b.properties.tabColor,pageSetup:b.pageSetup&&b.pageSetup.fitToPage?{fitToPage:b.pageSetup.fitToPage}:void 0},e=b.pageSetup&&b.pageSetup.margins,f={showRowColHeaders:b.showRowColHeaders,showGridLines:b.showGridLines,horizontalCentered:b.horizontalCentered,verticalCentered:b.verticalCentered};this.map.sheetPr.render(a,d),this.map.dimension.render(a,b.dimensions),this.map.sheetViews.render(a,b.views),this.map.sheetFormatPr.render(a,c),this.map.cols.render(a,b.cols),this.map.sheetData.render(a,b.rows),this.map.autoFilter.render(a,b.autoFilter),this.map.mergeCells.render(a,b.mergeCells),this.map.dataValidations.render(a,b.dataValidations),this.map.hyperlinks.render(a,b.hyperlinks),this.map.pageMargins.render(a,e),this.map.printOptions.render(a,f),this.map.pageSetup.render(a,b.pageSetup),a.closeNode()},parseOpen:function(a){return this.parser?(this.parser.parseOpen(a),!0):"worksheet"===a.name?(_.each(this.map,function(a){a.reset()}),!0):(this.parser=this.map[a.name],this.parser&&this.parser.parseOpen(a),!0)},parseText:function(a){this.parser&&this.parser.parseText(a)},parseClose:function(a){if(this.parser)return this.parser.parseClose(a)||(this.parser=void 0),!0;switch(a){case"worksheet":var b=this.map.sheetFormatPr.model;this.map.sheetPr.model&&this.map.sheetPr.model.tabColor&&(b.tabColor=this.map.sheetPr.model.tabColor);var c={fitToPage:this.map.sheetPr.model&&this.map.sheetPr.model.pageSetup&&this.map.sheetPr.model.pageSetup.fitToPage||!1,margins:this.map.pageMargins.model},d=Object.assign(c,this.map.pageSetup.model,this.map.printOptions.model);return this.model={dimensions:this.map.dimension.model,cols:this.map.cols.model,rows:this.map.sheetData.model,mergeCells:this.map.mergeCells.model,hyperlinks:this.map.hyperlinks.model,dataValidations:this.map.dataValidations.model,properties:b,views:this.map.sheetViews.model,pageSetup:d},!1;default:return!0}},reconcile:function(a,b){b.hyperlinkMap=new HyperlinkMap(a.relationships,a.hyperlinks),b.formulae={},a.rows=a.rows&&a.rows.filter(Boolean)||[],a.rows.forEach(function(a){a.cells=a.cells&&a.cells.filter(Boolean)||[]}),this.map.cols.reconcile(a.cols,b),this.map.sheetData.reconcile(a.rows,b),a.relationships=void 0,a.hyperlinks=void 0}});