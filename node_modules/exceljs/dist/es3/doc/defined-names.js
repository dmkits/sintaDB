/*! ExcelJS 28-04-2017 */
"use strict";var _=require("../utils/under-dash"),colCache=require("../utils/col-cache"),CellMatrix=require("../utils/cell-matrix"),Range=require("./range"),rangeRegexp=/\$(\w+)\$(\d+)(:\$(\w+)\$(\d+))?/;(module.exports=function(){this.matrixMap={}}).prototype={getMatrix:function(a){return this.matrixMap[a]||(this.matrixMap[a]=new CellMatrix)},add:function(a,b){var c=colCache.decodeEx(a);this.addEx(c,b)},addEx:function(a,b){var c=this.getMatrix(b);if(a.top)for(var d=a.left;d<=a.right;d++)for(var e=a.top;e<=a.bottom;e++){var f={sheetName:a.sheetName,address:colCache.n2l(d)+e,row:e,col:d};c.addCellEx(f)}else c.addCellEx(a)},remove:function(a,b){var c=colCache.decodeEx(a);this.removeEx(c,b)},removeEx:function(a,b){this.getMatrix(b).removeCellEx(a)},removeAllNames:function(a){_.each(this.matrixMap,function(b){b.removeCellEx(a)})},forEach:function(a){_.each(this.matrixMap,function(b,c){b.forEach(function(b){a(c,b)})})},getNames:function(a){return this.getNamesEx(colCache.decodeEx(a))},getNamesEx:function(a){return _.map(this.matrixMap,function(b,c){if(b.findCellEx(a))return c}).filter(function(a){return a})},_explore:function(a,b){function c(c,d){var e=a.findCellAt(g,c,b.col);return!(!e||!e.mark||(h[d]=c,e.mark=!1,0))}function d(b,c){var d,e=[];for(f=h.top;f<=h.bottom;f++){if(d=a.findCellAt(g,f,b),!d||!d.mark)return!1;e.push(d)}h[c]=b;for(var i=0;i<e.length;i++)e[i].mark=!1;return!0}b.mark=!1;var e,f,g=b.sheetName,h=new Range(b.row,b.col,b.row,b.col,g);for(f=b.row-1;c(f,"top");f--);for(f=b.row+1;c(f,"bottom");f++);for(e=b.col-1;d(e,"left");e--);for(e=b.col+1;d(e,"right");e++);return h},getRanges:function(a,b){var c=this;return(b=b||this.matrixMap[a])?(b.forEach(function(a){a.mark=!0}),{name:a,ranges:b.map(function(a){return a.mark&&c._explore(b,a)}).filter(function(a){return a}).map(function(a){return a.$shortRange})}):{name:a,ranges:[]}},get model(){var a=this;return _.map(this.matrixMap,function(b,c){return a.getRanges(c,b)}).filter(function(a){return a.ranges.length})},set model(a){var b=this.matrixMap={};a.forEach(function(a){var c=b[a.name]=new CellMatrix;a.ranges.forEach(function(a){rangeRegexp.test(a.split("!").pop()||"")&&c.addCell(a)})})}};