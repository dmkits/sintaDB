/*! ExcelJS 28-04-2017 */
"use strict";var _=require("../utils/under-dash"),utils=require("./../utils/utils"),colCache=require("./../utils/col-cache"),Range=require("./range"),Row=require("./row"),Column=require("./column"),Enums=require("./enums"),DataValidations=require("./data-validations");(module.exports=function(a){a=a||{},this.id=a.id,this.name=a.name||"Sheet"+this.id,this._rows=[],this._columns=null,this._keys={},this._merges={},this._workbook=a.workbook,this.properties=Object.assign({},{defaultRowHeight:15,dyDescent:55,outlineLevelCol:0,outlineLevelRow:0},a.properties),this.pageSetup=Object.assign({},{margins:{left:.7,right:.7,top:.75,bottom:.75,header:.3,footer:.3},orientation:"portrait",horizontalDpi:4294967295,verticalDpi:4294967295,fitToPage:!(!a.pageSetup||!a.pageSetup.fitToWidth&&!a.pageSetup.fitToHeight||a.pageSetup.scale),pageOrder:"downThenOver",blackAndWhite:!1,draft:!1,cellComments:"None",errors:"displayed",scale:100,fitToWidth:1,fitToHeight:1,paperSize:void 0,showRowColHeaders:!1,showGridLines:!1,firstPageNumber:void 0,horizontalCentered:!1,verticalCentered:!1,rowBreaks:null,colBreaks:null},a.pageSetup),this.dataValidations=new DataValidations,this.views=a.views||[],this.autoFilter=a.autoFilter||null}).prototype={get workbook(){return this._workbook},destroy:function(){this._workbook._removeWorksheet(this)},get dimensions(){var a=new Range;return this._rows.forEach(function(b){if(b){var c=b.dimensions;c&&a.expand(b.number,c.min,b.number,c.max)}}),a},get columns(){return this._columns},set columns(a){var b=this;this._headerRowCount=a.reduce(function(a,b){var c=b.header&&1||b.headers&&b.headers.length||0;return Math.max(a,c)},0);var c=1,d=this._columns=[];a.forEach(function(a){var e=new Column(b,c++,!1);d.push(e),e.defn=a})},getColumn:function(a){if("string"==typeof a){var b=this._keys[a];if(b)return b;a=colCache.l2n(a)}if(this._columns||(this._columns=[]),a>this._columns.length)for(var c=this._columns.length+1;c<=a;)this._columns.push(new Column(this,c++));return this._columns[a-1]},spliceColumns:function(a,b){var c,d=Array.prototype.slice.call(arguments,2),e=this._rows,f=e.length;if(d.length>0)for(c=0;c<f;c++){var g=[a,b];d.forEach(function(a){g.push(a[c]||null)});var h=this.getRow(c+1);h.splice.apply(h,g)}else this._rows.forEach(function(c){c&&c.splice(a,b)});var i=d.length-b,j=a+b,k=this._columns.length;if(i<0){for(c=j;c<=k;c++)this.getColumn(c+i).defn=this.getColumn(c).defn;for(c=k+i+1;c<=k;c++)this.getColumn(c).defn=null}else for(c=k;c>=j;c--)this.getColumn(c+i).defn=this.getColumn(c).defn;for(c=a;c<j+i;c++)this.getColumn(c).defn=null},get columnCount(){var a=0;return this.eachRow(function(b){a=Math.max(a,b.cellCount)}),a},get actualColumnCount(){var a=[],b=0;return this.eachRow(function(c){c.eachCell(function(c){var d=c.col;a[d]||(a[d]=!0,b++)})}),b},_commitRow:function(){},get _lastRowNumber(){for(var a=this._rows,b=a.length;b>0&&void 0===a[b-1];)b--;return b},get _nextRow(){return this._lastRowNumber+1},get lastRow(){if(this._rows.length)return this._rows[this._rows.length-1]},findRow:function(a){return this._rows[a-1]},get rowCount(){return this._lastRowNumber},get actualRowCount(){var a=0;return this.eachRow(function(){a++}),a},getRow:function(a){var b=this._rows[a-1];return b||(b=this._rows[a-1]=new Row(this,a)),b},addRow:function(a){var b=this.getRow(this._nextRow);return b.values=a,b},addRows:function(a){var b=this;a.forEach(function(a){b.addRow(a)})},spliceRows:function(a,b){var c,d,e=Array.prototype.slice.call(arguments,2),f=a+b,g=e.length-b,h=this._rows.length;if(g<0)for(c=f;c<=h;c++)d=this._rows[c-1],d?(this.getRow(c+g).values=d.values,this._rows[c-1]=void 0):this._rows[c+g-1]=void 0;else if(g>0)for(c=h;c>=f;c--)d=this._rows[c-1],d?this.getRow(c+g).values=d.values:this._rows[c+g-1]=void 0;for(c=0;c<e.length;c++)this.getRow(a+c).values=e[c]},eachRow:function(a,b){if(b||(b=a,a=void 0),a&&a.includeEmpty)for(var c=this._rows.length,d=1;d<=c;d++)b(this.getRow(d),d);else this._rows.forEach(function(a){a&&a.hasValues&&b(a,a.number)})},getSheetValues:function(){var a=[];return this._rows.forEach(function(b){b&&(a[b.number]=b.values)}),a},findCell:function(a,b){var c=colCache.getAddress(a,b),d=this._rows[c.row-1];return d?d.findCell(c.col):void 0},getCell:function(a,b){var c=colCache.getAddress(a,b);return this.getRow(c.row)._getCell(c)},mergeCells:function(){var a=new Range(Array.prototype.slice.call(arguments,0));_.each(this._merges,function(b){if(b.intersects(a))throw new Error("Cannot merge already merged cells")});for(var b=this.getCell(a.top,a.left),c=a.top;c<=a.bottom;c++)for(var d=a.left;d<=a.right;d++)(c>a.top||d>a.left)&&this.getCell(c,d).merge(b);this._merges[b.address]=a},_unMergeMaster:function(a){var b=this._merges[a.address];if(b){for(var c=b.top;c<=b.bottom;c++)for(var d=b.left;d<=b.right;d++)this.getCell(c,d).unmerge();delete this._merges[a.address]}},get hasMerges(){return _.some(this._merges,function(a,b){return!0})},unMergeCells:function(){for(var a=new Range(Array.prototype.slice.call(arguments,0)),b=a.top;b<=a.bottom;b++)for(var c=a.left;c<=a.right;c++){var d=this.findCell(b,c);d&&(d.type===Enums.ValueType.Merge?this._unMergeMaster(d.master):this._merges[d.address]&&this._unMergeMaster(d))}},fillFormula:function(a,b,c){var d,e=colCache.decode(a),f=e.top,g=e.left,h=e.bottom,i=e.right,j=i-g+1,k=colCache.encodeAddress(f,g);d="function"==typeof c?c:Array.isArray(c)?Array.isArray(c[0])?function(a,b){return c[a-f][b-g]}:function(a,b){return c[(a-f)*j+(b-g)]}:function(){};for(var l=!0,m=f;m<=h;m++)for(var n=g;n<=i;n++)l?(this.getCell(m,n).value={formula:b,result:d(m,n)},l=!1):this.getCell(m,n).value={sharedFormula:k,result:d(m,n)}},get tabColor(){return console.trace("worksheet.tabColor property is now deprecated. Please use worksheet.properties.tabColor"),this.properties.tabColor},set tabColor(a){console.trace("worksheet.tabColor property is now deprecated. Please use worksheet.properties.tabColor"),this.properties.tabColor=a},get model(){var a={id:this.id,name:this.name,dataValidations:this.dataValidations.model,properties:this.properties,pageSetup:this.pageSetup,views:this.views,autoFilter:this.autoFilter};a.cols=Column.toModel(this.columns);var b=a.rows=[],c=a.dimensions=new Range;return this._rows.forEach(function(a){var d=a&&a.model;d&&(c.expand(d.number,d.min,d.number,d.max),b.push(d))}),a.merges=[],_.each(this._merges,function(b){a.merges.push(b.range)}),a},_parseRows:function(a){var b=this;this._rows=[],a.rows.forEach(function(a){var c=new Row(b,a.number);b._rows[c.number-1]=c,c.model=a})},_parseMergeCells:function(a){var b=this;_.each(a.mergeCells,function(a){b.mergeCells(a)})},set model(a){this.name=a.name,this._columns=Column.fromModel(this,a.cols),this._parseRows(a),this._parseMergeCells(a),this.dataValidations=new DataValidations(a.dataValidations),this.properties=a.properties,this.pageSetup=a.pageSetup,this.views=a.views}};