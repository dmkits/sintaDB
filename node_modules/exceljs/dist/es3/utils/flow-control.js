/*! ExcelJS 28-04-2017 */
"use strict";var events=require("events"),PromishLib=require("./promish"),utils=require("./utils"),FlowControl=module.exports=function(a){if(this.options=a=a||{},this.queue=[],this.pipes=[],this.children=[],this.parent=a.parent,this.flushing=!1,a.gc){var b=a.gc;if(b.getTimeout)this.getTimeout=b.getTimeout;else{var c=void 0!==b.threshold?b.threshold:15e7,d=void 0!==b.divisor?b.divisor:5e5;this.getTimeout=function(){var a=process.memoryUsage(),b=a.heapTotal;return b<c?0:Math.floor(b/d)}}}else this.getTimeout=null};utils.inherits(FlowControl,events.EventEmitter,{get name(){return["FlowControl",this.parent?"Child":"Root",this.corked?"corked":"open"].join(" ")},get corked(){return this.children.length>0&&this.children.some(function(a){return a.queue&&a.queue.length})},get stem(){return this.corked||!this.queue||this.queue.length>2},_write:function(a,b,c){return new PromishLib.Promish(function(d,e){a.write(b,c,function(a){a?e(a):d()})})},_pipe:function(a){var b=this,c=[];return this.pipes.forEach(function(d){a.data?d.sync?d.stream.write(a.data,a.encoding):c.push(b._write(d.stream,a.data,a.encoding)):d.stream.end()}),c.length||c.push(PromishLib.Promish.resolve()),PromishLib.Promish.all(c).then(function(){try{a.callback()}catch(a){}})},_animate:function(){var a=0,b=["|","/","-","\\"];return setInterval(function(){process.stdout.write(b[a++%4]+"[0G")},100)},_delay:function(){var a=this.getTimeout&&this.getTimeout(),b=this;return a?new PromishLib.Promish(function(c,d){var e=b._animate();setTimeout(function(){clearInterval(e),c()},a)}):PromishLib.Promish.resolve()},_flush:function(){var a=this;!this.queue||this.flushing||this.corked||(this.queue.length&&(this.flushing=!0,a._delay().then(function(){return a._pipe(a.queue.shift())}).then(function(){setImmediate(function(){a.flushing=!1,a._flush()})})),this.stem||a.emit("drain"))},write:function(a,b,c){if(b instanceof Function&&(c=b,b="utf8"),c=c||utils.nop,!this.queue)throw new Error("Cannot write to stream after end");return this.queue.push({data:a,encoding:b,callback:c}),this._flush(),!(this.corked||this.queue.length>3)},end:function(a,b,c){var d=this;this.queue.push({callback:function(){d.queue=null,d.emit("finish")}}),this._flush()},pipe:function(a,b){b=b||{};var c=b.sync||!1;this.pipes.push({stream:a,sync:c})},unpipe:function(a){this.pipes=this.pipes.filter(function(b){return b.stream!==a})},createChild:function(){var a=this,b=Object.assign({parent:this},this.options),c=new FlowControl(b);return this.children.push(c),c.on("drain",function(){a._flush()}),c.on("finish",function(){a.children=a.children.filter(function(a){return a!==c}),a._flush()}),c}});