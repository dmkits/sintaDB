/*! ExcelJS 28-04-2017 */
"use strict";var Stream=require("stream"),PromishLib=require("./promish"),utils=require("./utils"),StringBuf=require("./string-buf"),StringChunk=function(a,b){this._data=a,this._encoding=b};StringChunk.prototype={get length(){return this.toBuffer().length},copy:function(a,b,c,d){return this.toBuffer().copy(a,b,c,d)},toBuffer:function(){return this._buffer||(this._buffer=new Buffer(this._data,this._encoding)),this._buffer}};var StringBufChunk=function(a){this._data=a};StringBufChunk.prototype={get length(){return this._data.length},copy:function(a,b,c,d){return this._data._buf.copy(a,b,c,d)},toBuffer:function(){return this._data.toBuffer()}};var BufferChunk=function(a){this._data=a};BufferChunk.prototype={get length(){return this._data.length},copy:function(a,b,c,d){this._data.copy(a,b,c,d)},toBuffer:function(){return this._data}};var ReadWriteBuf=function(a){this.size=a,this.buffer=new Buffer(a),this.iRead=0,this.iWrite=0};ReadWriteBuf.prototype={toBuffer:function(){if(0===this.iRead&&this.iWrite===this.size)return this.buffer;var a=new Buffer(this.iWrite-this.iRead);return this.buffer.copy(a,0,this.iRead,this.iWrite),a},get length(){return this.iWrite-this.iRead},get eod(){return this.iRead===this.iWrite},get full(){return this.iWrite===this.size},read:function(a){var b;return 0===a?null:void 0===a||a>=this.length?(b=this.toBuffer(),this.iRead=this.iWrite,b):(b=new Buffer(a),this.buffer.copy(b,0,this.iRead,a),this.iRead+=a,b)},write:function(a,b,c){var d=Math.min(c,this.size-this.iWrite);return a.copy(this.buffer,this.iWrite,b,b+d),this.iWrite+=d,d}};var StreamBuf=module.exports=function(a){a=a||{},this.bufSize=a.bufSize||1048576,this.buffers=[],this.batch=a.batch||!1,this.corked=!1,this.inPos=0,this.outPos=0,this.pipes=[],this.paused=!1,this.encoding=null};utils.inherits(StreamBuf,Stream.Duplex,{_getWritableBuffer:function(){if(this.buffers.length){var a=this.buffers[this.buffers.length-1];if(!a.full)return a}var b=new ReadWriteBuf(this.bufSize);return this.buffers.push(b),b},_pipe:function(a){var b=function(b){return new PromishLib.Promish(function(c,d){b.write(a.toBuffer(),function(){c()})})},c=this.pipes.map(b);return c.length?PromishLib.Promish.all(c).then(utils.nop):PromishLib.Promish.resolve()},_writeToBuffers:function(a){for(var b=0,c=a.length;b<c;){b+=this._getWritableBuffer().write(a,b,c-b)}},write:function(a,b,c){b instanceof Function&&(c=b,b="utf8"),c=c||utils.nop;var d;if(d=a instanceof StringBuf?new StringBufChunk(a):a instanceof Buffer?new BufferChunk(a):new StringChunk(a,b),this.pipes.length)if(this.batch)for(this._writeToBuffers(d);!this.corked&&this.buffers.length>1;)this._pipe(this.buffers.shift());else this.corked?(this._writeToBuffers(d),process.nextTick(c)):this._pipe(d).then(c);else this.paused||this.emit("data",d.toBuffer()),this._writeToBuffers(d),this.emit("readable");return!0},cork:function(){this.corked=!0},_flush:function(a){if(this.pipes.length)for(;this.buffers.length;)this._pipe(this.buffers.shift())},uncork:function(){this.corked=!1,this._flush()},end:function(a,b,c){var d=this,e=function(a){a?c(a):(d._flush(),d.pipes.forEach(function(a){a.end()}),d.emit("finish"))};a?this.write(a,b,e):e()},read:function(a){var b;if(a){for(b=[];a&&this.buffers.length&&!this.buffers[0].eod;){var c=this.buffers[0],d=c.read(a);a-=d.length,b.push(d),c.eod&&c.full&&this.buffers.shift()}return Buffer.concat(b)}return b=this.buffers.map(function(a){return a.toBuffer()}).filter(function(a){return a}),this.buffers=[],Buffer.concat(b)},setEncoding:function(a){this.encoding=a},pause:function(){this.paused=!0},resume:function(){this.paused=!1},isPaused:function(){return!!this.paused},pipe:function(a,b){this.pipes.push(a),!this.paused&&this.buffers.length&&this.end()},unpipe:function(a){this.pipes=this.pipes.filter(function(b){return b!==a})},unshift:function(a){throw new Error("Not Implemented")},wrap:function(a){throw new Error("Not Implemented")}});