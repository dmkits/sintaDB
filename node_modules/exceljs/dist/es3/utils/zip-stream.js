/*! ExcelJS 28-04-2017 */
"use strict";var events=require("events"),PromishLib=require("./promish"),JSZip=require("jszip"),utils=require("./utils"),StreamBuf=require("./stream-buf"),ZipReader=function(){var a=this;this.count=0,this.jsZip=new JSZip,this.stream=new StreamBuf,this.stream.on("finish",function(){a._process()})};utils.inherits(ZipReader,events.EventEmitter,{_finished:function(){var a=this;--this.count||PromishLib.Promish.resolve().then(function(){a.emit("finished")})},_process:function(){var a=this,b=this.stream.read();this.jsZip.loadAsync(b).then(function(b){b.forEach(function(b,c){c.dir||(a.count++,c.async("string").then(function(c){var d=new StreamBuf;d.path=b,d.write(c),d.autodrain=function(){a._finished()},d.on("finish",function(){a._finished()}),a.emit("entry",d)}).catch(function(b){a.emit("error",b)}))})}).catch(function(b){a.emit("error",b)})},write:function(a,b,c){return this.stream.write(a,b,c)},cork:function(){return this.stream.cork()},uncork:function(){return this.stream.uncork()},end:function(){return this.stream.end()}});var ZipWriter=function(){this.zip=new JSZip,this.stream=new StreamBuf};utils.inherits(ZipWriter,events.EventEmitter,{append:function(a,b){this.zip.file(b.name,a)},finalize:function(){var a=this,b={type:"nodebuffer",compression:"DEFLATE"};return this.zip.generateAsync(b).then(function(b){a.stream.end(b),a.emit("finish")})},read:function(a){return this.stream.read(a)},setEncoding:function(a){return this.stream.setEncoding(a)},pause:function(){return this.stream.pause()},resume:function(){return this.stream.resume()},isPaused:function(){return this.stream.isPaused()},pipe:function(a,b){return this.stream.pipe(a,b)},unpipe:function(a){return this.stream.unpipe(a)},unshift:function(a){return this.stream.unshift(a)},wrap:function(a){return this.stream.wrap(a)}}),module.exports={ZipReader:ZipReader,ZipWriter:ZipWriter};