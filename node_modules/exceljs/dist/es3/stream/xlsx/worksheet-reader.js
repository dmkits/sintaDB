/*! ExcelJS 28-04-2017 */
"use strict";var fs=require("fs"),events=require("events"),Sax=require("sax"),utils=require("../../utils/utils"),colCache=require("../../utils/col-cache"),Dimensions=require("../../doc/range"),Row=require("../../doc/row"),Column=require("../../doc/column"),WorksheetReader=module.exports=function(a,b){this.workbook=a,this.id=b,this.name="Sheet"+this.id,this._columns=null,this._keys={},this._dimensions=new Dimensions};utils.inherits(WorksheetReader,events.EventEmitter,{destroy:function(){throw new Error("Invalid Operation: destroy")},get dimensions(){return this._dimensions},get columns(){return this._columns},getColumn:function(a){if("string"==typeof a){var b=this._keys[a];if(b)return b;a=colCache.l2n(a)}if(this._columns||(this._columns=[]),a>this._columns.length)for(var c=this._columns.length+1;c<=a;)this._columns.push(new Column(this,c++));return this._columns[a-1]},_emitRow:function(a){this.emit("row",a)},read:function(a,b,c){var d=this,e=!1,f=!1,g=null;switch(b.worksheets){case"emit":e=!0;break;case"prep":!0}switch(b.hyperlinks){case"emit":f=!0;break;case"cache":this.hyperlinks=g={}}if(!e&&!f&&!g)return void a.autodrain();var h=this.workbook.sharedStrings,i=this.workbook.styles,j=!1,k=!1,l=!1,m=null,n=null,o=null,p=null,q=Sax.createStream(!0,{});q.on("opentag",function(a){if(e)switch(a.name){case"cols":j=!0,m=[];break;case"sheetData":k=!0;break;case"col":j&&m.push({min:parseInt(a.attributes.min,10),max:parseInt(a.attributes.max,10),width:parseFloat(a.attributes.width),styleId:parseInt(a.attributes.style||"0",10)});break;case"row":if(k){if(n=new Row(d,parseInt(a.attributes.r,10)),a.attributes.ht&&(n.height=parseFloat(a.attributes.ht)),a.attributes.s){var b=parseInt(a.attributes.s,10);n.style=i.getStyleModel(b)}}break;case"c":n&&(o={ref:a.attributes.r,s:parseInt(a.attributes.s,10),t:a.attributes.t});break;case"f":o&&(p=o.f={text:""});break;case"v":o&&(p=o.v={text:""});break;case"mergeCell":}if(f||g)switch(a.name){case"hyperlinks":l=!0;break;case"hyperlink":if(l){var c={ref:a.attributes.ref,rId:a.attributes["r:id"]};f?d.emit("hyperlink",c):g[c.ref]=c}}}),q.on("text",function(a){e&&p&&(p.text+=a)}),q.on("closetag",function(a){if(e)switch(a){case"cols":j=!1,d._columns=Column.fromModel(m);break;case"sheetData":k=!1;break;case"row":d._dimensions.expandRow(n),d._emitRow(n),n=null;break;case"c":if(n&&o){var b=colCache.decodeAddress(o.ref),c=n.getCell(b.col);if(o.s&&(c.style=d.workbook.styles.getStyleModel(o.s)),o.f){var i={formula:o.f.text};o.v&&("str"===o.t?i.result=utils.xmlDecode(o.v.text):i.result=parseFloat(o.v.text)),c.value=i}else if(o.v)switch(o.t){case"s":var p=parseInt(o.v.text,10);c.value=h?h[p]:{sharedString:p};break;case"str":c.value=utils.xmlDecode(o.v.text);break;default:utils.isDateFmt(c.numFmt)?c.value=utils.excelToDate(parseFloat(o.v.text)):c.value=parseFloat(o.v.text)}o=null}}if(f||g)switch(a){case"hyperlinks":l=!1}}),q.on("error",function(a){d.emit("error",a)}),q.on("end",function(){d.emit("finished")});var r=this.workbook.flowControl.createChild();r.pipe(q,{sync:!0}),a.pipe(r)}});