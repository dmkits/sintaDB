/*! ExcelJS 28-04-2017 */
"use strict";var fs=require("fs"),events=require("events"),Stream=require("stream"),unzip=require("unzip2"),Sax=require("sax"),utils=require("../../utils/utils"),FlowControl=require("../../utils/flow-control"),StyleManager=require("../../xlsx/xform/style/styles-xform"),WorksheetReader=require("./worksheet-reader"),HyperlinkReader=require("./hyperlink-reader"),WorkbookReader=module.exports=function(a){this.options=a=a||{},this.styles=new StyleManager.Mock,this.worksheetReaders={},this.hyperlinkReaders={},this.readers=0,this.atEnd=!1};utils.inherits(WorkbookReader,events.EventEmitter,{_getStream:function(a){if(a instanceof Stream.Readable)return a;if("string"==typeof a)return fs.createReadStream(a);throw new Error("Could not recognise input")},get flowControl(){return this._flowControl||(this._flowControl=new FlowControl(this.options)),this._flowControl},options:{entries:["emit"],sharedStrings:["cache","emit"],styles:["cache"],hyperlinks:["cache","emit"],worksheets:["emit"]},read:function(a,b){var c=this,d=this.stream=this._getStream(a),e=this.zip=unzip.Parse();e.on("entry",function(a){var d,e;switch(a.path){case"_rels/.rels":case"xl/workbook.xml":case"xl/_rels/workbook.xml.rels":a.autodrain();break;case"xl/sharedStrings.xml":c._parseSharedStrings(a,b);break;case"xl/styles.xml":c._parseStyles(a,b);break;default:a.path.match(/xl\/worksheets\/sheet\d+\.xml/)?(d=a.path.match(/xl\/worksheets\/sheet(\d+)\.xml/),e=d[1],c._parseWorksheet(a,e,b)):a.path.match(/xl\/worksheets\/_rels\/sheet\d+\.xml.rels/)?(d=a.path.match(/xl\/worksheets\/_rels\/sheet(\d+)\.xml.rels/),e=d[1],c._parseHyperlinks(a,e,b)):a.autodrain()}}),e.on("close",function(){c.emit("end"),c.atEnd=!0,c.readers||c.emit("finished")}),d.pipe(e)},_emitEntry:function(a,b){"emit"===a.entries&&this.emit("entry",b)},_parseSharedStrings:function(a,b){this._emitEntry(b,{type:"shared-strings"});var c=this,d=null;switch(b.sharedStrings){case"cache":d=this.sharedStrings=[];break;case"emit":break;default:return void a.autodrain()}var e=Sax.createStream(!0,{}),f=!1,g=null,h=0;e.on("opentag",function(a){"t"===a.name&&(g=null,f=!0)}),e.on("closetag",function(a){f&&"t"===a&&(d?d.push(g):c.emit("shared-string",{index:h++,text:g}),g=null)}),e.on("text",function(a){g=g?g+a:a}),e.on("error",function(a){c.emit("error",a)}),a.pipe(e)},_parseStyles:function(a,b){if(this._emitEntry(b,{type:"styles"}),"cache"!==b.styles)return void a.autodrain();this.styles=new StyleManager,this.styles.parse(a)},_getReader:function(a,b,c){var d=this,e=b[c];return e||(e=new a(this,c),d.readers++,e.on("finished",function(){--d.readers||d.atEnd&&d.emit("finished")}),b[c]=e),e},_parseWorksheet:function(a,b,c){this._emitEntry(c,{type:"worksheet",id:b});var d=this._getReader(WorksheetReader,this.worksheetReaders,b);"emit"===c.worksheets&&this.emit("worksheet",d),d.read(a,c,this.hyperlinkReaders[b])},_parseHyperlinks:function(a,b,c){this._emitEntry(c,{type:"hyerlinks",id:b});var d=this._getReader(HyperlinkReader,this.hyperlinkReaders,b);"emit"===c.hyperlinks&&this.emit("hyperlinks",d),d.read(a,c)}});